"use strict";const e=require("../common/vendor.js"),t=require("../constants/index.js"),r=new Map;let a=0;const s=new class{constructor(){this.baseURL=(()=>{let r="";try{r=e.index.getStorageSync(t.STORAGE_KEYS.DEBUG_BASE_API)||""}catch(a){}return r||(r="http://localhost:8080"),r.replace(/\/+$/,"")+"/api"})(),this.timeout=3e4,this.header={"Content-Type":"application/json;charset=utf-8"}}getHeaders(){const r={...this.header};r["x-platform"]="wechat",r["x-app-id"]=t.PLATFORM.APP_ID;const a=e.index.getStorageSync(t.STORAGE_KEYS.TOKEN);return a&&(r.Authorization=`Bearer ${a}`),r}beforeRequest(r){if(r.header={...this.getHeaders(),...r.header},r.url=r.url.startsWith("http")?r.url:this.baseURL+r.url,r.timeout=r.timeout||this.timeout,r._requestId=++a,"GET"!==r.method&&"DELETE"!==r.method||!r.params||r.data||(r.data=r.params),"POST"===r.method)try{const a=e.index.getStorageSync(t.STORAGE_KEYS.TOKEN);a&&(r.header&&(delete r.header.Authorization,delete r.header.authorization),r.data||(r.data={}),"object"==typeof r.data&&null!==r.data&&(Object.prototype.hasOwnProperty.call(r.data,"token")||Object.prototype.hasOwnProperty.call(r.data,"access_token")||(r.data.token=a)))}catch(s){}return r}afterResponse(e,a){r.delete(a._requestId);const{statusCode:s,data:o}=e;return s>=200&&s<300?o&&void 0!==o.code?o.code===t.API_CODES.SUCCESS||0===o.code?void 0!==o.data?o.data:o:Promise.reject(this.handleBusinessError(o,a)):o:Promise.reject(this.handleHttpError(s,o,a))}handleBusinessError(r,a){const{code:s,message:o}=r;return s===t.API_CODES.UNAUTHORIZED&&this.handleUnauthorized(),a.silent||e.index.showToast({title:o||"请求失败",icon:"none"}),{code:s,message:o,data:r.data}}handleHttpError(t,r,a){let s="网络请求失败";switch(t){case 401:s="登录已过期",this.handleUnauthorized();break;case 403:s="没有权限";break;case 404:s="请求地址不存在";break;case 500:s="服务器错误";break;case 502:case 503:s="服务暂不可用";break;default:s=(null==r?void 0:r.message)||`请求失败(${t})`}return a.silent||e.index.showToast({title:s,icon:"none"}),{code:t,message:s,data:r}}handleUnauthorized(){e.index.removeStorageSync(t.STORAGE_KEYS.TOKEN),e.index.removeStorageSync(t.STORAGE_KEYS.USER_INFO);const r=getCurrentPages(),a=r[r.length-1],s=a?`/${a.route}`:"";s!==t.PAGES.LOGIN&&e.index.redirectTo({url:`${t.PAGES.LOGIN}?redirect=${encodeURIComponent(s)}`})}request(t){const a=this.beforeRequest(t);return new Promise((t,s)=>{const o=e.index.request({...a,success:e=>{try{const r=this.afterResponse(e,a);Promise.resolve(r).then(t).catch(s)}catch(r){s(r)}},fail:t=>{r.delete(a._requestId),a.silent||e.index.showToast({title:t.errMsg||"网络请求失败",icon:"none"}),s(t)}});r.set(a._requestId,o)})}get(e,t={}){return this.request({...t,url:e,method:"GET"})}post(e,t={},r={}){return this.request({...r,url:e,data:t,method:"POST"})}put(e,t={},r={}){return this.request({...r,url:e,data:t,method:"PUT"})}delete(e,t={}){return this.request({...t,url:e,method:"DELETE"})}upload(r,a){const s=this.beforeRequest({url:r,method:"UPLOAD",...a});return new Promise((r,o)=>{const n={...a.formData||{}};try{const r=e.index.getStorageSync(t.STORAGE_KEYS.TOKEN);!r||n.token||n.access_token||(n.token=r)}catch(d){}e.index.uploadFile({url:s.url,filePath:a.filePath,name:a.name||"file",header:s.header,formData:n,success:e=>{try{const a=JSON.parse(e.data);a.code===t.API_CODES.SUCCESS||0===a.code?r(a.data||a):o(this.handleBusinessError(a,s))}catch(d){o({code:-1,message:"解析响应失败"})}},fail:e=>{o(e)}})})}cancelAll(){r.forEach(e=>{e&&e.abort&&e.abort()}),r.clear()}};exports.cancelAllRequests=()=>s.cancelAll(),exports.http=s;
