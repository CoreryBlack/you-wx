"use strict";const e=require("../../common/vendor.js"),n=require("../../api/modules/auth.js");require("../../utils/http.js"),require("../../store/index.js");const t=require("../../utils/router.js"),a=require("../../constants/index.js"),o=require("../../store/modules/user.js"),l={__name:"bind-phone",setup(l){const u=o.useUserStore(),i=e.ref(""),r=e.ref(""),s=e.ref(""),c=getCurrentPages(),v=c[c.length-1],d=(null==v?void 0:v.options)||{},p=d.openId||d.openid||null,h=e.index.getStorageSync("wx_temp_openId")||null,m=p||h||"",f=e.index.getStorageSync("wx_temp_user")||null;f&&(f.nickName&&(i.value=f.nickName),f.nickname&&!i.value&&(i.value=f.nickname),f.phone&&(r.value=f.phone));const x=e.ref(!1),g=e.ref(!1),w=e.ref(0);let k=null;const _=async()=>{if(!r.value)return e.index.showToast({title:"请输入手机号",icon:"none"});if(!(g.value||w.value>0)){g.value=!0;try{await n.sendSmsCode({phone:r.value}),e.index.showToast({title:"验证码已发送",icon:"success"}),w.value=60,k=setInterval(()=>{w.value-=1,w.value<=0&&(clearInterval(k),k=null)},1e3)}catch(t){}finally{g.value=!1}}},y=async()=>{if(!x.value){if(!i.value)return e.index.showToast({title:"请输入姓名",icon:"none"});if(!r.value)return e.index.showToast({title:"请输入手机号",icon:"none"});if(!s.value)return e.index.showToast({title:"请输入验证码",icon:"none"});x.value=!0;try{const l={name:i.value,phone:r.value,code:s.value};m&&(l.openId=m);const c=await n.bindPhone(l);c&&c.token?u.login({token:c.token,userInfo:{id:c.id,nickName:c.nickName,avatarUrl:c.avatarUrl,phone:c.phone}}):u.updateUserInfo({phone:c.phone||r.value,nickName:c.nickName||i.value});try{e.index.removeStorageSync("wx_temp_openId")}catch(o){}e.index.showToast({title:"绑定成功",icon:"success"}),setTimeout(()=>{var e;const n=getCurrentPages(),o=n[n.length-1],l=(null==(e=null==o?void 0:o.options)?void 0:e.redirect)?decodeURIComponent(o.options.redirect):a.PAGES.PERSONAL;t.router.reLaunch(l)},800)}catch(l){e.index.showToast({title:(null==l?void 0:l.message)||"绑定失败",icon:"none"})}finally{x.value=!1}}};return(n,t)=>({a:i.value,b:e.o(e=>i.value=e.detail.value),c:r.value,d:e.o(e=>r.value=e.detail.value),e:s.value,f:e.o(e=>s.value=e.detail.value),g:e.t(w.value>0?w.value+"s":"发送验证码"),h:g.value||w.value>0,i:e.o(_),j:e.o(y),k:x.value})}},u=e._export_sfc(l,[["__scopeId","data-v-d56f7004"]]);wx.createPage(u);
