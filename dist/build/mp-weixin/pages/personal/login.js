"use strict";const e=require("../../common/vendor.js"),n=require("../../common/assets.js");require("../../store/index.js");const r=require("../../api/modules/auth.js");require("../../utils/http.js");const o=require("../../constants/index.js"),t=require("../../utils/router.js"),s=require("../../store/modules/user.js"),i={__name:"login",setup(i){const a=s.useUserStore(),u=e.ref(!1),c=()=>{const e=getCurrentPages(),n=e[e.length-1],r=(null==n?void 0:n.options)||{};return r.redirect?decodeURIComponent(r.redirect):o.PAGES.INDEX},d=async()=>{var n,s,i;if(!u.value){u.value=!0;try{const s=await e.index.login({provider:"weixin"}),i=Array.isArray(s)?null==(n=s[1])?void 0:n.code:s.code;if(!i)throw new Error("获取登录凭证失败");const l=await r.wxLogin({code:i});if(l&&l.needBind){l.openId&&e.index.setStorageSync("wx_temp_openId",l.openId);const n=l.user||l.userInfo||l.user_data||l.data||null;if(n){const r={nickName:n.nickname||n.nickName||n.nick||n.userName||"",avatarUrl:n.avatar_url||n.avatarUrl||n.avatar||"",phone:n.phone||""};try{e.index.setStorageSync("wx_temp_user",r)}catch(d){}try{a.setUserInfo(r)}catch(d){}}u.value=!1,e.index.showToast({title:"需要绑定手机号",icon:"none",duration:1200});const r=c();return void t.router.push(`${o.PAGES.BIND_PHONE}?redirect=${encodeURIComponent(r)}`,{checkLogin:!1})}const v=l.user||l.userInfo||{},m=v.user_id||v.userId||v.id||"",_={...v,userId:m,user_id:m,id:m,nickName:v.nickname||v.nickName||"",avatarUrl:v.avatar||v.avatar_url||v.avatarUrl||""};a.login({token:l.token,userInfo:_}),e.index.showToast({title:"登录成功",icon:"success",duration:1500}),setTimeout(()=>{const e=c();t.router.reLaunch(e)},1500)}catch(l){let n="登录失败，请重试";(null==(s=null==l?void 0:l.errMsg)?void 0:s.includes("cancel"))||(null==(i=null==l?void 0:l.errMsg)?void 0:i.includes("deny"))?n="需要授权才能登录":(null==l?void 0:l.message)&&(n=l.message),e.index.showToast({title:n,icon:"none",duration:2e3})}finally{u.value=!1}}},l=()=>{e.index.showToast({title:"敬请期待",icon:"none"})},v=()=>{e.index.showToast({title:"敬请期待",icon:"none"})};return(r,o)=>({a:n._imports_0$2,b:n._imports_1$1,c:n._imports_2,d:e.o(d),e:u.value,f:u.value,g:e.o(l),h:e.o(v)})}},a=e._export_sfc(i,[["__scopeId","data-v-2cf74d35"]]);wx.createPage(a);
