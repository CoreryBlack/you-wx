"use strict";const e=require("../../common/vendor.js"),t=require("../../api/modules/transactions.js");require("../../store/index.js");const r=require("../../store/modules/user.js"),n={__name:"transactions",setup(n){const u=r.useUserStore(),a=e.ref([]),s=e.ref(1),o=e.ref(20),i=e.ref(0),c=e.ref(!1),l=e.ref(!1),d=e.computed(()=>{const t=u.userInfo||{},r=t.userId||t.user_id||t.id||null;if(r)return r;const n=e.index.getStorageSync("wx_temp_user")||null;return n&&(n.user_id||n.userId||n.id)||null}),f=async(e=!1)=>{if(!c.value)if(d.value){c.value=!0;try{e&&(s.value=1,a.value=[]);const r=await t.getTransactions({user_id:d.value,page:s.value,limit:o.value}),n=r&&r.data?r.data:r,u=Array.isArray(n)?n:n.records||n.list||[],c=u.map(v);a.value=e?c:a.value.concat(c),i.value=n.total??n.count??n.totalCount??(n.totalPages?n.total||u.length:n.total||u.length||0)}catch(r){}finally{c.value=!1}}else l.value=!0},g=e.computed(()=>a.value.length<(i.value||0)),m=e.computed(()=>a.value);function v(e){const t=e.orderId||e.order_id||"",r=e.txnId||e.txn_id||e.id||"",n=e.amountCents??e.amount_cents??e.amount??0,u=function(e,t){const r=(t||"").toString();if(/充值/.test(r))return"油卡充值";if(/退款/.test(r))return"退款";if(/积分/.test(r)&&/增|增加/.test(r))return"积分增加";if(/积分/.test(r)&&/消|消费/.test(r))return"积分消费";if(/支出|消费/.test(r))return"支出";const n=Number(e.type);switch(n){case 1:case 2:return"油卡充值";case 3:return"支出";case 4:return"积分增加";case 5:return"积分消费";case 6:return"退款";default:return r||(Number.isFinite(n)?String(n):"其他")}}(e,e.typeLabel||e.typeDesc||e.type_desc||e.typeName||""),a=e.cardNo||e.card_no||"",s=a&&String(a)||"",o=s&&s!==String(r)&&s!==String(t);return{...e,orderIdShort:e.orderIdShort||x(t||r),txnIdShort:e.txnIdShort||x(r||t),cardNoMasked:e.cardNoMasked||(o?_(s):""),amountStr:e.amountStr||(i=n,`¥${S(i).toFixed(2)}`),typeLabel:u,createTime:e.createTime||p(e.create_time||e.created_at||e.createTime),statusDesc:e.statusDesc||h(e.status)};var i}function S(e){const t=Number(e)||0;return Number((t/100).toFixed(2))}function p(e){if(!e)return"";const t=new Date(e);if(isNaN(t))return String(e);const r=e=>String(e).padStart(2,"0");return`${t.getFullYear()}-${r(t.getMonth()+1)}-${r(t.getDate())} ${r(t.getHours())}:${r(t.getMinutes())}:${r(t.getSeconds())}`}function _(e){if(!e)return"";const t=String(e).slice(-4);return t?`****...${t}`:""}function h(e){return 1===e?"成功":0===e?"失败":null==e?"":String(e)}function I(e){return e?1===e.status?"is-success":0===e.status?"is-fail":"is-pending":""}function x(e){if(!e)return"";const t=String(e);if(t.length<=10)return t;return`${t.slice(0,6)}...${t.slice(-4)}`}const y=()=>{g.value&&(s.value+=1,f())},N=()=>{const{PAGES:e}=require("@/constants");require("@/utils/router").default.push(e.LOGIN)};return e.onMounted(()=>{f(!0)}),e.onShow(()=>{f(!0)}),(t,r)=>e.e({a:e.f(m.value,(t,r,n)=>({a:e.t(t.txnIdShort||t.txnId||t.orderId||t.id||""),b:e.t(t.statusDesc),c:e.n(I(t)),d:e.t(t.createTime),e:e.t(t.typeLabel||t.typeDesc||t.type||""),f:e.t(t.amountStr||(t.amount?`¥${Number(t.amount).toFixed(2)}`:"")),g:t.id||t.txnId||t.orderId})),b:0===a.value.length&&!l.value},(0!==a.value.length||l.value,{}),{c:l.value},l.value?{d:e.o(N)}:{},{e:g.value},g.value?{f:e.o(y)}:{})}},u=e._export_sfc(n,[["__scopeId","data-v-cc3999ed"]]);wx.createPage(u);
