"use strict";const e=require("../../common/vendor.js");require("../../store/index.js");const a=require("../../api/modules/user.js"),t=require("../../store/modules/user.js"),r=6e4,u=5e3,l={__name:"qrcode",setup(l){const o=t.useUserStore(),n=e.computed(()=>o.userInfo||{}),s=e.computed(()=>o.userName||n.value.nickName||n.value.phone||"未登录"),i=e.computed(()=>o.userAvatar||n.value.avatar||"/static/personal/avatar.png"),c=e.computed(()=>n.value.memberCode||n.value.code||n.value.id||n.value.userId||n.value.openId||n.value.phone||""),v=e.computed(()=>c.value?String(c.value):"未绑定会员码"),d=e.ref(""),p=e.ref(!1),m=e.ref(""),f=e.ref(null);let x=null;async function g(){if(c.value){p.value=!0,m.value="";try{const l=await a.getMemberCode({user_id:c.value}),o=l&&l.data?l.data:l;let n=o.url||o.qrUrl||o.image||o.data||"";if(!n&&o.base64&&(n=`data:image/png;base64,${o.base64}`),!n&&o.code){n=`https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=${encodeURIComponent(String(o.code))}`}if(!n){n=`https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=${encodeURIComponent(String(c.value))}`}d.value=n,f.value=Date.now();let s=6e4;try{const e=["expiresAt","expires_at","expireAt","expire_at","expires","expire","ttl","expiresIn","expires_in"];let a=null;for(const t of e)if(Object.prototype.hasOwnProperty.call(o,t)&&null!=o[t]){a=o[t];break}if(null!=a){let e=null;if("number"==typeof a)e=a>1e12||a>1e10?a:1e3*a;else if("string"==typeof a){const t=Number(a);if(isNaN(t)){const t=Date.parse(a);isNaN(t)||(e=t)}else e=t>1e12?t:1e3*t}if(!e&&o.ttl){const a=Number(o.ttl);isNaN(a)||(e=Date.now()+1e3*a)}if(e){s=Math.max(5e3,e-Date.now()-5e3)}}}catch(t){}e=s,b(),x=setTimeout(()=>{g()},Math.max(u,e||r))}catch(l){m.value="获取会员码失败"}finally{p.value=!1}var e}}function b(){x&&(clearTimeout(x),x=null)}return e.onMounted(async()=>{if(!n.value||0===Object.keys(n.value).length)try{const e=await a.getUserInfo();e&&e.data&&o.setUserInfo(e.data||e)}catch(e){}await g()}),e.onUnmounted(()=>{b()}),(a,t)=>e.e({a:i.value,b:e.t(s.value),c:d.value},d.value?{d:d.value}:{e:e.t(p.value?"加载中…":m.value||"暂无会员码")},{f:e.t(v.value),g:e.o(g),h:p.value,i:f.value},f.value?{j:e.t(new Date(f.value).toLocaleString())}:{})}},o=e._export_sfc(l,[["__scopeId","data-v-32962174"]]);wx.createPage(o);
