"use strict";const e=require("../common/vendor.js"),t=require("../constants/index.js"),r=new Map;let s=0;const a=new class{constructor(){this.baseURL=(()=>{let r="";try{r=e.index.getStorageSync(t.STORAGE_KEYS.DEBUG_BASE_API)||""}catch(s){}return r||(r="http://localhost:8080"),r.replace(/\/+$/,"")+"/api"})(),this.timeout=3e4,this.header={"Content-Type":"application/json;charset=utf-8"}}getHeaders(){const r={...this.header};r["x-platform"]="wechat",r["x-app-id"]=t.PLATFORM.APP_ID;const s=e.index.getStorageSync(t.STORAGE_KEYS.TOKEN);return s&&(r.Authorization=`Bearer ${s}`),r}beforeRequest(e){return e.header={...this.getHeaders(),...e.header},e.url=e.url.startsWith("http")?e.url:this.baseURL+e.url,e.timeout=e.timeout||this.timeout,e._requestId=++s,"GET"!==e.method&&"DELETE"!==e.method||!e.params||e.data||(e.data=e.params),e}afterResponse(e,s){r.delete(s._requestId);const{statusCode:a,data:o}=e;return a>=200&&a<300?o&&void 0!==o.code?o.code===t.API_CODES.SUCCESS||0===o.code?void 0!==o.data?o.data:o:Promise.reject(this.handleBusinessError(o,s)):o:Promise.reject(this.handleHttpError(a,o,s))}handleBusinessError(r,s){const{code:a,message:o}=r;return a===t.API_CODES.UNAUTHORIZED&&this.handleUnauthorized(),s.silent||e.index.showToast({title:o||"请求失败",icon:"none"}),{code:a,message:o,data:r.data}}handleHttpError(t,r,s){let a="网络请求失败";switch(t){case 401:a="登录已过期",this.handleUnauthorized();break;case 403:a="没有权限";break;case 404:a="请求地址不存在";break;case 500:a="服务器错误";break;case 502:case 503:a="服务暂不可用";break;default:a=(null==r?void 0:r.message)||`请求失败(${t})`}return s.silent||e.index.showToast({title:a,icon:"none"}),{code:t,message:a,data:r}}handleUnauthorized(){e.index.removeStorageSync(t.STORAGE_KEYS.TOKEN),e.index.removeStorageSync(t.STORAGE_KEYS.USER_INFO);const r=getCurrentPages(),s=r[r.length-1],a=s?`/${s.route}`:"";a!==t.PAGES.LOGIN&&e.index.redirectTo({url:`${t.PAGES.LOGIN}?redirect=${encodeURIComponent(a)}`})}request(t){const s=this.beforeRequest(t);return new Promise((t,a)=>{const o=e.index.request({...s,success:e=>{try{const r=this.afterResponse(e,s);Promise.resolve(r).then(t).catch(a)}catch(r){a(r)}},fail:t=>{r.delete(s._requestId),s.silent||e.index.showToast({title:t.errMsg||"网络请求失败",icon:"none"}),a(t)}});r.set(s._requestId,o)})}get(e,t={}){return this.request({...t,url:e,method:"GET"})}post(e,t={},r={}){return this.request({...r,url:e,data:t,method:"POST"})}put(e,t={},r={}){return this.request({...r,url:e,data:t,method:"PUT"})}delete(e,t={}){return this.request({...t,url:e,method:"DELETE"})}upload(r,s){const a=this.beforeRequest({url:r,method:"UPLOAD",...s});return new Promise((r,o)=>{e.index.uploadFile({url:a.url,filePath:s.filePath,name:s.name||"file",header:a.header,formData:s.formData||{},success:e=>{try{const s=JSON.parse(e.data);s.code===t.API_CODES.SUCCESS||0===s.code?r(s.data||s):o(this.handleBusinessError(s,a))}catch(s){o({code:-1,message:"解析响应失败"})}},fail:e=>{o(e)}})})}cancelAll(){r.forEach(e=>{e&&e.abort&&e.abort()}),r.clear()}};exports.cancelAllRequests=()=>a.cancelAll(),exports.http=a;
